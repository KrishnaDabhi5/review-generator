<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Get Started - AIRAA</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="/static/styles.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap');
    
    #map {
      width: 100%;
      height: 400px;
      margin: 10px 0;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
    }
  </style>
</head>
<body>
  <div class="container wizard">
    <a href="/" class="back-link">← Back to Home</a>

    <div class="wizard-head">
      <div class="wizard-brand">
        <div class="wizard-mark">AIRAA</div>
        <div class="wizard-title">Get Started</div>
      </div>
      <div class="wizard-steps" id="wizardSteps" aria-label="Setup steps"></div>
    </div>

    <div class="wizard-body">
      <div class="panel" id="step0">
        <h2>Set up your restaurant</h2>
        <div class="sub">We’ll guide you through a quick setup in a few steps.</div>

        <div class="cards">
          <div class="mini-card">
            <div class="mini-title">Step 1</div>
            <div class="mini-text">Business name</div>
          </div>
          <div class="mini-card">
            <div class="mini-title">Step 2</div>
            <div class="mini-text">City</div>
          </div>
          <div class="mini-card">
            <div class="mini-title">Step 3</div>
            <div class="mini-text">Location on map</div>
          </div>
          <div class="mini-card">
            <div class="mini-title">Step 4</div>
            <div class="mini-text">Menu items</div>
          </div>
          <div class="mini-card">
            <div class="mini-title">Step 5</div>
            <div class="mini-text">SEO keywords</div>
          </div>
        </div>

        <button type="button" id="startBtn">Get Started</button>
      </div>

      <div class="panel" id="step1" style="display:none;">
        <h2>Business Name</h2>
        <div class="sub">Enter the restaurant name exactly as you want it to appear.</div>

        <label>Restaurant Name
          <input id="businessName" placeholder="e.g. My Fine Dining" autocomplete="off" />
        </label>

        <div class="wizard-actions">
          <button type="button" class="btn-secondary" data-back>Back</button>
          <button type="button" data-next>Continue</button>
        </div>
      </div>

      <div class="panel" id="step2" style="display:none;">
        <h2>City</h2>
        <div class="sub">This helps us generate SEO suggestions and local context.</div>

        <label>City Name
          <input id="cityName" placeholder="e.g. Surat" autocomplete="off" />
        </label>

        <div class="wizard-actions">
          <button type="button" class="btn-secondary" data-back>Back</button>
          <button type="button" data-next>Continue</button>
        </div>
      </div>

      <div class="panel" id="step3" style="display:none;">
        <h2>Pick Location</h2>
        <div class="sub">Search or tap on the map to set your restaurant location.</div>

        <div class="map-tools">
          <input id="mapSearch" placeholder="Search area (optional)" autocomplete="off" />
          <button type="button" class="btn-secondary" id="mapSearchBtn">Search</button>
        </div>

        <div class="map" id="map"></div>

        <div class="map-meta" id="mapMeta">No location selected yet.</div>

        <div class="wizard-actions">
          <button type="button" class="btn-secondary" data-back>Back</button>
          <button type="button" data-next>Continue</button>
        </div>
      </div>

      <div class="panel" id="step4" style="display:none;">
        <h2>Add Menu</h2>
        <div class="sub">Add your menu items one by one. You can remove items anytime.</div>

        <div class="menu-add">
          <input id="menuItemInput" placeholder="e.g. Paneer Handi" autocomplete="off" />
          <button type="button" class="btn-secondary" id="addMenuItemBtn">Add</button>
        </div>

        <div class="chips" id="menuChips"></div>

        <div class="wizard-actions">
          <button type="button" class="btn-secondary" data-back>Back</button>
          <button type="button" data-next>Continue</button>
        </div>
      </div>

      <div class="panel" id="step5" style="display:none;">
        <h2>SEO Keywords</h2>
        <div class="sub">Pick the best keywords for your restaurant. We suggest based on city + menu.</div>

        <div class="seo-top">
          <div class="seo-box">
            <div class="seo-label">Suggested</div>
            <div class="chips" id="seoSuggestions"></div>
          </div>

          <div class="seo-box">
            <div class="seo-label">Selected <span class="seo-count" id="seoCount"></span></div>
            <div class="chips" id="seoSelected"></div>

            <div class="seo-add">
              <input id="seoCustom" placeholder="Add custom keyword and press Enter" autocomplete="off" />
            </div>

            <div class="seo-hint" id="seoHint"></div>
          </div>
        </div>

        <div class="wizard-actions">
          <button type="button" class="btn-secondary" data-back>Back</button>
          <button type="button" id="finishBtn">Finish Setup</button>
        </div>
      </div>

      <div class="panel" id="step6" style="display:none;">
        <h2>Setup Complete</h2>
        <div class="sub">Saved your menu + profile. You can now generate reviews.</div>

        <div class="summary" id="summary"></div>

        <button type="button" id="goGenerate">Generate Reviews</button>
      </div>
    </div>

    <div id="err"></div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script>
    const MAX_SEO_KEYWORDS = 15;

    const state = {
      business: '',
      city: '',
      lat: null,
      lng: null,
      menu: [],
      seo: []
    };

    const errEl = document.getElementById('err');

    function showError(msg) {
      errEl.style.display = 'block';
      errEl.textContent = msg;
    }

    function clearError() {
      errEl.style.display = 'none';
      errEl.textContent = '';
    }

    const steps = [
      { id: 'step0', label: 'Start' },
      { id: 'step1', label: 'Business' },
      { id: 'step2', label: 'City' },
      { id: 'step3', label: 'Map' },
      { id: 'step4', label: 'Menu' },
      { id: 'step5', label: 'SEO' },
      { id: 'step6', label: 'Done' }
    ];

    let currentStep = 0;

    function renderStepper() {
      const root = document.getElementById('wizardSteps');
      root.innerHTML = '';
      for (let i = 1; i < steps.length - 1; i++) {
        const el = document.createElement('div');
        el.className = 'wiz-step' + (i <= currentStep ? ' active' : '');
        el.innerHTML = `<div class="dot">${i}</div><div class="txt">${steps[i].label}</div>`;
        root.appendChild(el);
      }
    }

    function showStep(idx) {
      clearError();
      currentStep = idx;
      steps.forEach((s, i) => {
        const panel = document.getElementById(s.id);
        panel.style.display = i === idx ? 'block' : 'none';
      });
      renderStepper();

      if (steps[idx].id === 'step3') {
        ensureMap();
        setTimeout(() => {
          if (map) map.invalidateSize(true);
        }, 50);
      }

      if (steps[idx].id === 'step5') {
        refreshSeoUI();
      }
    }

    function validateAndPersist(idx) {
      if (steps[idx].id === 'step1') {
        const v = (document.getElementById('businessName').value || '').trim();
        if (!v) return showError('Please enter restaurant name');
        state.business = v;
        try { localStorage.setItem('rg_restaurant', v); } catch (e) {}
      }

      if (steps[idx].id === 'step2') {
        const v = (document.getElementById('cityName').value || '').trim();
        if (!v) return showError('Please enter city name');
        state.city = v;
      }

      if (steps[idx].id === 'step3') {
        if (state.lat == null || state.lng == null) return showError('Please pick a location on the map');
      }

      if (steps[idx].id === 'step4') {
        if (!state.menu.length) return showError('Please add at least 1 menu item');
      }

      return true;
    }

    document.getElementById('startBtn').addEventListener('click', () => {
      showStep(1);
      const saved = (localStorage.getItem('rg_restaurant') || '').trim();
      if (saved) document.getElementById('businessName').value = saved;
    });

    document.querySelectorAll('[data-next]').forEach(btn => {
      btn.addEventListener('click', () => {
        if (!validateAndPersist(currentStep)) return;
        showStep(currentStep + 1);
      });
    });

    document.querySelectorAll('[data-back]').forEach(btn => {
      btn.addEventListener('click', () => {
        showStep(Math.max(0, currentStep - 1));
      });
    });

    function normalizeKeyword(s) {
      return (s || '').toLowerCase().replace(/\s+/g, ' ').trim();
    }

    function addMenuItem(name) {
      const clean = normalizeKeyword(name);
      if (!clean) return;
      if (state.menu.includes(clean)) return;
      state.menu.push(clean);
      renderMenuChips();
    }

    function removeMenuItem(name) {
      state.menu = state.menu.filter(x => x !== name);
      renderMenuChips();
    }

    function renderMenuChips() {
      const root = document.getElementById('menuChips');
      root.innerHTML = '';
      state.menu.forEach(item => {
        const chip = document.createElement('button');
        chip.type = 'button';
        chip.className = 'chip';
        chip.innerHTML = `<span>${item}</span><span class="x">×</span>`;
        chip.addEventListener('click', () => removeMenuItem(item));
        root.appendChild(chip);
      });
    }

    document.getElementById('addMenuItemBtn').addEventListener('click', () => {
      const el = document.getElementById('menuItemInput');
      const v = (el.value || '').trim();
      if (!v) return;
      addMenuItem(v);
      el.value = '';
      el.focus();
    });

    document.getElementById('menuItemInput').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        document.getElementById('addMenuItemBtn').click();
      }
    });

    function inferCuisineKeywords(menu) {
      const text = menu.join(' ');
      const hits = [];
      const cuisines = {
        indian: ['dal','curry','naan','tandoori','biryani','masala','dosa','idly','vada','paneer'],
        italian: ['pizza','pasta','risotto','carbonara','pesto'],
        chinese: ['fried rice','chow mein','wonton','dim sum','manchurian','momo'],
        mexican: ['taco','burrito','enchilada','salsa','nachos'],
        thai: ['pad thai','tom yum','satay','green curry','red curry'],
        american: ['burger','steak','rib','wing','sandwich','fries']
      };
      Object.entries(cuisines).forEach(([k, words]) => {
        for (const w of words) {
          if (text.includes(w)) { hits.push(k); break; }
        }
      });
      return Array.from(new Set(hits));
    }

    function buildSeoSuggestions() {
      const biz = state.business.trim();
      const city = state.city.trim();
      const menu = state.menu;
      const cuisines = inferCuisineKeywords(menu);

      const suggestions = [];
      if (biz && city) {
        suggestions.push(`${biz} ${city}`);
        suggestions.push(`best restaurant in ${city}`);
        suggestions.push(`best food in ${city}`);
        suggestions.push(`family restaurant in ${city}`);
        suggestions.push(`restaurant near me`);
      }

      cuisines.forEach(c => {
        if (city) suggestions.push(`best ${c} restaurant in ${city}`);
        suggestions.push(`${c} food`);
      });

      menu.slice(0, 12).forEach(item => {
        suggestions.push(item);
        if (city) suggestions.push(`${item} in ${city}`);
      });

      const normalized = new Set();
      const out = [];
      for (const s of suggestions) {
        const k = normalizeKeyword(s);
        if (!k) continue;
        if (normalized.has(k)) continue;
        normalized.add(k);
        out.push(s);
      }
      return out.slice(0, 30);
    }

    function addSeoKeyword(s) {
      const k = normalizeKeyword(s);
      if (!k) return;
      if (state.seo.includes(k)) return;
      if (state.seo.length >= MAX_SEO_KEYWORDS) {
        showError(`You can select up to ${MAX_SEO_KEYWORDS} keywords.`);
        return;
      }
      state.seo.push(k);
      refreshSeoUI();
    }

    function removeSeoKeyword(k) {
      state.seo = state.seo.filter(x => x !== k);
      refreshSeoUI();
    }

    function refreshSeoUI() {
      const suggestions = buildSeoSuggestions();
      const sugRoot = document.getElementById('seoSuggestions');
      const selRoot = document.getElementById('seoSelected');
      const countEl = document.getElementById('seoCount');
      const hintEl = document.getElementById('seoHint');

      countEl.textContent = `(${state.seo.length}/${MAX_SEO_KEYWORDS})`;
      hintEl.textContent = state.seo.length ? 'Tip: keep keywords short and specific.' : 'Pick a few keywords to help customers find you on Google.';

      sugRoot.innerHTML = '';
      suggestions.forEach(s => {
        const k = normalizeKeyword(s);
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'chip suggest' + (state.seo.includes(k) ? ' selected' : '');
        btn.textContent = s;
        btn.addEventListener('click', () => {
          clearError();
          if (state.seo.includes(k)) removeSeoKeyword(k);
          else addSeoKeyword(s);
        });
        sugRoot.appendChild(btn);
      });

      selRoot.innerHTML = '';
      state.seo.forEach(k => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'chip selected';
        btn.innerHTML = `<span>${k}</span><span class="x">×</span>`;
        btn.addEventListener('click', () => removeSeoKeyword(k));
        selRoot.appendChild(btn);
      });

      const custom = document.getElementById('seoCustom');
      custom.placeholder = state.seo.length >= MAX_SEO_KEYWORDS ? `Limit reached (${MAX_SEO_KEYWORDS})` : 'Add custom keyword and press Enter';
      custom.disabled = state.seo.length >= MAX_SEO_KEYWORDS;
    }

    document.getElementById('seoCustom').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        clearError();
        const v = (e.target.value || '').trim();
        if (!v) return;
        addSeoKeyword(v);
        e.target.value = '';
      }
    });

    async function finishSetup() {
      clearError();
      if (!state.seo.length) {
        showError('Please select at least 1 SEO keyword');
        return;
      }

      const menu_items = state.menu.map((name, idx) => ({ name, rank: idx + 1 }));

      const addMenuRes = await fetch('/api/add-menu', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ restaurant: state.business, menu_items })
      }).then(r => r.json().then(j => ({ ok: r.ok, j })).catch(() => ({ ok: r.ok, j: {} })));

      if (!addMenuRes.ok) {
        showError(addMenuRes.j?.detail || 'Failed to save menu');
        return;
      }

      const profileRes = await fetch('/api/restaurant-profile', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          restaurant: state.business,
          city: state.city,
          lat: state.lat,
          lng: state.lng,
          seo_keywords: state.seo
        })
      }).then(r => r.json().then(j => ({ ok: r.ok, j })).catch(() => ({ ok: r.ok, j: {} })));

      if (!profileRes.ok) {
        showError(profileRes.j?.detail || 'Failed to save profile');
        return;
      }

      const summary = document.getElementById('summary');
      summary.innerHTML = `
        <div class="sum-row"><div class="k">Restaurant</div><div class="v">${state.business}</div></div>
        <div class="sum-row"><div class="k">City</div><div class="v">${state.city}</div></div>
        <div class="sum-row"><div class="k">Menu Items</div><div class="v">${state.menu.length}</div></div>
        <div class="sum-row"><div class="k">SEO Keywords</div><div class="v">${state.seo.length}</div></div>
      `;

      showStep(6);
    }

    document.getElementById('finishBtn').addEventListener('click', finishSetup);

    document.getElementById('goGenerate').addEventListener('click', () => {
      const url = `/test?restaurant=${encodeURIComponent(state.business)}`;
      window.location.href = url;
    });

    let map = null;
    let marker = null;

    function setPickedLocation(lat, lng) {
      state.lat = lat;
      state.lng = lng;
      const meta = document.getElementById('mapMeta');
      meta.textContent = `Selected: ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
    }

    function ensureMap() {
      if (map) return true;

      const mapEl = document.getElementById('map');
      if (!mapEl) {
        console.error('Map container not found');
        return false;
      }

      try {
        // Ensure map container is visible and has dimensions
        mapEl.style.display = 'block';
        mapEl.style.width = '100%';
        mapEl.style.height = '400px';
        
        // Initialize the map
        map = L.map('map', {
          zoomControl: true,
          preferCanvas: true
        });

        // Set initial view to a default location
        const initial = state.lat && state.lng ? [state.lat, state.lng] : [21.1702, 72.8311];
        map.setView(initial, 12);

        // Add the tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19,
          attribution: '&copy; OpenStreetMap',
          detectRetina: true
        }).addTo(map);

        // Handle map clicks to place markers
        map.on('click', (e) => {
          const { lat, lng } = e.latlng;
          if (!marker) {
            marker = L.marker([lat, lng], { draggable: true }).addTo(map);
            marker.on('dragend', () => {
              const p = marker.getLatLng();
              setPickedLocation(p.lat, p.lng);
            });
          } else {
            marker.setLatLng([lat, lng]);
          }
          setPickedLocation(lat, lng);
        });

        // Invalidate size to ensure proper rendering
        setTimeout(() => map.invalidateSize(), 100);
        return true;
      } catch (e) {
        console.error('Failed to initialize map:', e);
        return false;
      }
    }

    async function mapSearch() {
      clearError();
      const q = (document.getElementById('mapSearch').value || '').trim() || state.city;
      if (!q) {
        showError('Enter a search query or set city name');
        return;
      }
      
      try {
        // Show loading state
        const searchBtn = document.getElementById('mapSearchBtn');
        const originalText = searchBtn.textContent;
        searchBtn.disabled = true;
        searchBtn.textContent = 'Searching...';
        
        // Call the geocoding API
        const url = `/api/geocode?q=${encodeURIComponent(q)}`;
        const res = await fetch(url, { 
          headers: { 'Accept': 'application/json' } 
        });
        
        if (!res.ok) {
          const errorData = await res.json().catch(() => ({}));
          throw new Error(errorData.detail || 'Geocoding failed');
        }
        
        const { lat, lng } = await res.json();
        
        if (!Number.isFinite(lat) || !Number.isFinite(lng)) {
          throw new Error('Invalid coordinates received');
        }

        // Ensure map is properly initialized
        if (!ensureMap()) {
          throw new Error('Failed to initialize map');
        }
        
        // Update the map view and marker
        map.setView([lat, lng], 16);
        
        if (!marker) {
          marker = L.marker([lat, lng], { 
            draggable: true 
          }).addTo(map);
          
          marker.on('dragend', () => {
            const p = marker.getLatLng();
            setPickedLocation(p.lat, p.lng);
          });
        } else {
          marker.setLatLng([lat, lng]);
        }
        
        setPickedLocation(lat, lng);
        
      } catch (e) {
        console.error('Map search error:', e);
        showError(e?.message || 'Could not find location. Try a different search.');
      } finally {
        // Reset button state
        const searchBtn = document.getElementById('mapSearchBtn');
        if (searchBtn) {
          searchBtn.disabled = false;
          searchBtn.textContent = 'Search';
        }
      }
    }

    document.getElementById('mapSearchBtn').addEventListener('click', mapSearch);
    document.getElementById('mapSearch').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        mapSearch();
      }
    });

    showStep(0);
  </script>
</body>
</html>
